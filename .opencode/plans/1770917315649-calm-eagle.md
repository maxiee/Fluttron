# v0041: Acceptance and Regression Test Matrix - Work Plan

## Summary

Implement the final validation phase for the web package feature with:
- Integration tests in `test/integration/` that run real CLI commands
- Dart acceptance script with `@Tags(['acceptance', 'manual'])`
- Regression tests for "no web package" and "with web package" scenarios
- Documentation updates for MVP boundaries (per PRD §12)

---

## Test Architecture

### Current State (v0039-v0040)
- `ui_build_pipeline_test.dart` - **Unit tests with MOCKED dependencies**
- `create_command_test.dart` - **Integration-style** (creates real files, runs real CLI)
- Tests use `Directory.systemTemp.createTempSync()` for isolation
- No mockito - manual function injection
- 166 tests passing

### v0041 Target
- **Integration tests** in `test/integration/` (new directory)
- **Dart acceptance script** with test tags for CI/manual control
- **Regression tests** for backward compatibility
- Skip E2E (§13.3) in CI, document as manual verification

---

## Files to Create

### Directory Structure
```
packages/fluttron_cli/test/
├── integration/                              # NEW DIRECTORY
│   ├── test_helper.dart                      # Shared utilities
│   ├── no_web_package_regression_test.dart   # Regression: apps without packages
│   ├── with_web_package_regression_test.dart # Regression: apps with packages
│   └── acceptance_test.dart                  # PRD §13 tests
├── src/                                      # Existing
└── fluttron_cli_test.dart                    # Existing
```

### 1. Test Helper Utilities

**File:** `packages/fluttron_cli/test/integration/test_helper.dart`

```dart
import 'dart:io';
import 'package:path/path.dart' as p;

class IntegrationTestHelper {
  static const repoRoot = '/Volumes/ssd/Code/Fluttron';
  
  static Future<Directory> createTempProject(String name) async {
    final dir = await Directory.systemTemp.createTemp('${name}_');
    return dir;
  }
  
  static Future<int> runCli(List<String> args, {String? workingDir}) async {
    final result = await Process.run(
      'dart',
      ['run', '$repoRoot/packages/fluttron_cli/bin/fluttron.dart', ...args],
      workingDirectory: workingDir ?? repoRoot,
    );
    if (result.exitCode != 0) {
      print('STDERR: ${result.stderr}');
      print('STDOUT: ${result.stdout}');
    }
    return result.exitCode;
  }
  
  static Future<void> addPathDependency(Directory appDir, Directory pkgDir) async {
    final pubspec = File(p.join(appDir.path, 'ui', 'pubspec.yaml'));
    final content = await pubspec.readAsString();
    final relativePath = p.relative(pkgDir.path, from: p.join(appDir.path, 'ui'));
    await pubspec.writeAsString('$content\n  test_package:\n    path: $relativePath\n');
  }
  
  static Future<bool> fileContains(File file, String pattern) async {
    if (!await file.exists()) return false;
    return (await file.readAsString()).contains(pattern);
  }
}
```

### 2. Regression Test: No Web Package (6 tests)

**File:** `packages/fluttron_cli/test/integration/no_web_package_regression_test.dart`

```dart
group('Apps without web packages', () {
  test('build succeeds without discovering packages', () async {
    // Create app, build without any web packages
    // Assert: exitCode == 0
  });
  
  test('generated registrations file is placeholder', () async {
    // Assert: ui/lib/generated/web_package_registrations.dart exists
    // Assert: registerFluttronWebPackages() is empty function
  });
  
  test('HTML has no package script injections', () async {
    // Assert: no <script src="ext/packages/..."> in index.html
  });
  
  test('HTML has no package CSS injections', () async {
    // Assert: no <link href="ext/packages/..."> in index.html
  });
  
  test('ext/packages directory does not exist', () async {
    // Assert: host/assets/www/ext/packages/ should not exist
  });
  
  test('ext/main.js still loads correctly', () async {
    // Assert: host/assets/www/ext/main.js exists
  });
});
```

### 3. Regression Test: With Web Package (6 tests)

**File:** `packages/fluttron_cli/test/integration/with_web_package_regression_test.dart`

```dart
group('Apps with web packages', () {
  test('discovery finds web package', () async {
    // Assert: fluttron packages list shows the package
  });
  
  test('registration generates correct code', () async {
    // Assert: registerFluttronWebPackages() contains FluttronWebViewRegistry.register
  });
  
  test('assets collected to correct location', () async {
    // Assert: host/assets/www/ext/packages/<pkg>/main.js exists
  });
  
  test('HTML has package script injection', () async {
    // Assert: <script src="ext/packages/<pkg>/main.js"> exists
  });
  
  test('JS injected before ext/main.js', () async {
    // Assert: package scripts appear BEFORE local ext/main.js
  });
  
  test('CSS injected in head section', () async {
    // Assert: <link> tags in <head>, not <body>
  });
});
```

### 4. Acceptance Tests (PRD §13)

**File:** `packages/fluttron_cli/test/integration/acceptance_test.dart`

```dart
@Tags(['acceptance'])
group('PRD §13 Acceptance Tests', () {
  group('§13.1 Create Web Package', () {
    test('creates web package with correct structure', () async {
      // fluttron create ./test_package --name test_package --type web_package
      // Assert: fluttron_web_package.json exists
      // Assert: lib/test_package.dart exists
    });
    
    test('frontend builds successfully', () async {
      // pnpm install && pnpm run js:build
      // Assert: web/ext/main.js exists
    });
    
    test('dart analyze passes', () async {
      // cd test_package && dart analyze
      // Assert: exitCode == 0
    });
  });
  
  group('§13.2 Use Web Package in App', () {
    test('app builds with web package dependency', () async {
      // fluttron create ./test_app
      // Add path dependency
      // fluttron build -p .
      // Assert: exitCode == 0
    });
    
    test('JS injected in host HTML', () async {
      // grep 'ext/packages/test_package/main.js' host/assets/www/index.html
    });
    
    test('registrations generated', () async {
      // grep 'registerFluttronWebPackages' ui/lib/generated/web_package_registrations.dart
    });
  });
  
  group('§13.3 End-to-End', () {
    test('CI smoke: build artifacts valid', () async {
      // Verify host/assets/www structure
      // Verify generated code compiles
    });
    
    test('macOS app launches (manual)', () async {
      // Skip if !Platform.isMacOS || CI
      // fluttron run -p . -d macos --no-build
    }, tags: ['e2e', 'macos', 'manual']);
  });
});
```

### 5. Acceptance Script (Dart)

**File:** `scripts/acceptance.dart`

```dart
#!/usr/bin/env dart
// Run: dart run scripts/acceptance.dart
// Or: dart test --run-skipped -t acceptance

import 'dart:io';

Future<void> main() async {
  print('=== v0041 Acceptance Test ===\n');
  
  final results = <String, bool>{};
  
  // §13.1
  print('§13.1 Create Web Package...');
  results['13.1'] = await testCreateWebPackage();
  
  // §13.2
  print('§13.2 Use Web Package in App...');
  results['13.2'] = await testUseWebPackage();
  
  // §13.3 (CI smoke only)
  print('§13.3 CI Smoke Test...');
  results['13.3'] = await testBuildArtifacts();
  
  // Summary
  print('\n=== Results ===');
  results.forEach((k, v) => print('$k: ${v ? "PASS" : "FAIL"}'));
  
  final allPass = results.values.every((v) => v);
  exit(allPass ? 0 : 1);
}
```

---

## Documentation Updates

### Update `docs/dev_plan.md`

Replace the "下一步" section under v0040 with v0041 completion status and MVP Boundaries:

```markdown
## v0041 MVP Boundaries

The following features are **out of scope** for the current web package MVP:

| Feature | Status | Notes |
|---------|--------|-------|
| Hot Reload | Not in MVP | Future: auto-rebuild packages during development |
| pub.dev Distribution | Not in MVP | Current: path/git dependencies only |
| Type-Safe Event Generation | Not in MVP | Current: manual event handling |
| Selective Loading | Not in MVP | Current: all packages loaded at startup |
| CSS Auto-Scoping | Not in MVP | Current: convention-based (BEM) |
| Remote Packages (CDN) | Not in MVP | Future: runtime loading |

**Current Distribution Methods:**
- Path dependencies: Local development, monorepo
- Git dependencies: Remote repositories

**See:** `docs/feature/fluttron_web_package_prd.md` §12 for future roadmap
```

---

## Task Graph (Parallel Execution)

```
Phase 1 (Parallel) - Infrastructure
├── Task A: Create test/integration/ directory
├── Task B: Create test_helper.dart with shared utilities
└── Task C: Create scripts/acceptance.dart skeleton

Phase 2 (After B) - Regression Tests
├── Task D: Create no_web_package_regression_test.dart (6 tests)
└── Task E: Create with_web_package_regression_test.dart (6 tests)

Phase 3 (After D, E) - Acceptance Tests
└── Task F: Create acceptance_test.dart (PRD §13, 8 tests)

Phase 4 (After F) - Documentation
└── Task G: Update docs/dev_plan.md with MVP boundaries

Phase 5 (Final) - Verification
└── Task H: Run all tests, verify 166 + 20 = 186+ tests pass
```

---

## Verification

```bash
# 1. All unit tests (existing + new integration)
dart test packages/fluttron_cli/test/

# 2. Only integration tests
dart test packages/fluttron_cli/test/integration/

# 3. Acceptance tests (skipped by default)
dart test --run-skipped -t acceptance packages/fluttron_cli/test/

# 4. Acceptance script
dart run scripts/acceptance.dart

# 5. Manual E2E (requires macOS)
dart test --run-skipped -t e2e packages/fluttron_cli/test/
```

Expected test count: **186+ tests** (166 existing + 20 new)

---

## Critical Files

| File | Action | Tests |
|------|--------|-------|
| `test/integration/test_helper.dart` | **Create** | Utility class |
| `test/integration/no_web_package_regression_test.dart` | **Create** | 6 tests |
| `test/integration/with_web_package_regression_test.dart` | **Create** | 6 tests |
| `test/integration/acceptance_test.dart` | **Create** | 8 tests |
| `scripts/acceptance.dart` | **Create** | Script |
| `docs/dev_plan.md` | **Update** | MVP Boundaries |

---

## Edge Cases to Test

| Case | Test File | Assertion |
|------|-----------|-----------|
| No web packages | no_web_package_regression | Build succeeds, no injections |
| Empty manifest | with_web_package_regression | Graceful handling |
| Multiple packages | with_web_package_regression | Correct injection order |
| CSS-only package | with_web_package_regression | Only CSS injected |
| Missing JS asset | acceptance_test | Build fails with clear error |
| Path dependency | acceptance_test | Relative path resolution |

---

## Implementation Notes

### Test Isolation Pattern (Required)
```dart
late Directory tempDir;

setUp(() async {
  tempDir = await Directory.systemTemp.createTemp('v0041_test_');
});

tearDown() async {
  if (await tempDir.exists()) {
    await tempDir.delete(recursive: true);
  }
}
```

### CLI Execution Pattern
```dart
Future<int> runCli(List<String> args, {String? cwd}) async {
  final result = await Process.run(
    'dart',
    ['run', '$repoRoot/packages/fluttron_cli/bin/fluttron.dart', ...args],
    workingDirectory: cwd ?? repoRoot,
  );
  return result.exitCode;
}
```

### Skip E2E in CI
```dart
test('macOS app launches', () async {
  if (!Platform.isMacOS || Platform.environment['CI'] == 'true') {
    markTestSkipped('Requires macOS device outside CI');
    return;
  }
  // ... actual test
}, tags: ['e2e', 'macos', 'manual']);
```

### Test Tags for Filtering
- `@Tags(['acceptance'])` - PRD acceptance tests
- `@Tags(['regression'])` - Regression tests
- `@Tags(['e2e', 'manual'])` - Requires device, manual only
